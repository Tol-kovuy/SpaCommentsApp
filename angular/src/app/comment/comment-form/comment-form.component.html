<div class="comment-form-container">
  <h3>{{ isReply ? 'Add Reply' : 'Add Comment' }}</h3>

  <form class="comment-form" [formGroup]="commentForm" (ngSubmit)="onSubmit()">
    <div class="form-row">
      <div class="form-group">
        <label for="userName">User Name *</label>
        <input type="text"
               id="userName"
               class="form-control"
               formControlName="userName"
               autofocus
               placeholder="Your name">
        <div *ngIf="userName?.invalid && userName?.touched" class="error-message">
          <span *ngIf="userName?.errors?.['required']">Name is required</span>
          <span *ngIf="userName?.errors?.['minlength']">Name must be at least 2 characters</span>
        </div>
      </div>

      <div class="form-group">
        <label for="email">Email *</label>
        <input type="email"
               id="email"
               class="form-control"
               formControlName="email"
               placeholder="Your email">
        <div *ngIf="email?.invalid && email?.touched" class="error-message">
          <span *ngIf="email?.errors?.['required']">Email is required</span>
          <span *ngIf="email?.errors?.['email']">Please enter a valid email address</span>
        </div>
      </div>

      <div class="form-group">
        <label for="homepage">Homepage</label>
        <input type="url"
               id="homepage"
               class="form-control"
               formControlName="homepage"
               placeholder="Your website (optional)">
        <div *ngIf="homepage?.invalid && homepage?.touched" class="error-message">
          Please enter a valid URL
        </div>
      </div>
    </div>

    <div class="form-group">
      <div class="text-editor-header">
        <label for="text">Comment *</label>
        <div class="text-editor-controls">
          <button type="button"
                  class="btn-html-toggle"
                  (click)="toggleHtmlPanel()"
                  [class.active]="showHtmlPanel">
            HTML
          </button>
          <button type="button"
                  class="btn-validate-html"
                  (click)="validateHtml()"
                  title="Validate HTML">
            ‚úì Validate
          </button>
        </div>
      </div>

      <!-- HTML panel tools -->
      <div *ngIf="showHtmlPanel" class="html-panel">
        <div class="html-buttons">
          <button type="button"
                  class="html-btn"
                  (click)="insertHtmlTag('i')"
                  title="Italic">
            <i>I</i>
          </button>
          <button type="button"
                  class="html-btn"
                  (click)="insertHtmlTag('strong')"
                  title="Bold">
            <strong>B</strong>
          </button>
          <button type="button"
                  class="html-btn"
                  (click)="insertHtmlTag('code')"
                  title="Code">
            &lt;/&gt;
          </button>
          <button type="button"
                  class="html-btn"
                  (click)="insertLink()"
                  title="Insert Link">
            üîó
          </button>
        </div>
        <div class="html-hint">
          Select text and click buttons to wrap with HTML tags
        </div>
      </div>

      <textarea id="commentText"
                class="form-control mb-2"
                rows="5"
                formControlName="text"
                placeholder="Your comment"></textarea>
      <label for="text">(max comment lenght 1000 symbols)</label>

      <!-- Validation HTML -->
      <div *ngIf="showHtmlValidation" class="html-validation">
        <div class="validation-header">
          <strong>HTML Validation Errors:</strong>
        </div>
        <div class="validation-errors">
          <div *ngFor="let error of htmlValidationErrors" class="validation-error">
            ‚ùå {{ error }}
          </div>
        </div>
      </div>

      <div *ngIf="text?.invalid && text?.touched" class="error-message">
        <span *ngIf="text?.errors?.['required']">Comment text is required</span>
        <span *ngIf="text?.errors?.['minlength']">Comment must be at least 5 characters</span>
      </div>
    </div>

    <!-- File Attachment Section -->
    <div class="form-group">
      <label>File Attachment</label>
      <div class="file-upload-section">
        <input type="file"
               #fileInput
               (change)="onFileSelected($event)"
               accept=".jpg,.jpeg,.png,.gif,.txt"
               class="file-input-hidden">

        <button type="button"
                class="file-upload-button"
                (click)="fileInput.click()">
          üìé Attach File
        </button>

        <small class="file-hint">
          Images: JPG, PNG, GIF (max 5MB, will be resized to 320√ó240px) | Text: TXT only (max 100KB)
        </small>

        <!-- File Actions -->
        <div *ngIf="selectedFile" class="file-actions">
          <button type="button" class="btn-preview-file" (click)="previewFile()">
            üëÅÔ∏è Preview
          </button>
          <button type="button" class="btn-clear-file" (click)="clearFile()">
            üóëÔ∏è Remove
          </button>
        </div>
      </div>

      <!-- File validation errors -->
      <div *ngIf="fileError" class="error-message file-error">
        {{ fileError }}
      </div>
    </div>

    <!-- CAPTCHA Section -->
    <div *ngIf="!isReply" class="form-group">
      <label>CAPTCHA *</label>
      <div class="captcha-section">
        <app-captcha (captchaChanged)="onCaptchaChanged($event)"></app-captcha>
        <input type="text"
               class="form-control"
               formControlName="captcha"
               placeholder="Enter symbols from image">
        <div *ngIf="captcha?.invalid && captcha?.touched" class="error-message">
          <span *ngIf="captcha?.errors?.['required']">CAPTCHA answer is required</span>
        </div>
        <div *ngIf="captchaServerError" class="error-message">
          {{ captchaServerError }}
        </div>
      </div>
    </div>

    <!-- Form Actions -->
    <div class="form-actions">
      <button type="button"
              class="btn-preview"
              (click)="togglePreview()"
              [disabled]="isSubmitting || commentForm.invalid || !isHtmlValid()">
        {{ showPreview ? 'Hide Preview' : 'Show Preview' }}
      </button>

      <button type="submit"
              class="btn-submit"
              [disabled]="!canSubmit()"
              [class.loading]="isSubmitting">
        <span class="btn-icon">
          {{ isSubmitting ? '‚è≥' : '‚úì' }}
        </span>
        {{ isSubmitting ? 'Submitting...' : (isReply ? 'Submit Reply' : 'Submit Comment') }}
      </button>
    </div>

    <!-- Preview Section using CommentPreviewComponent -->
    <app-comment-preview *ngIf="showPreview && commentForm.valid && isHtmlValid()"
                         [commentData]="previewData"
                         [selectedFile]="selectedFile">
    </app-comment-preview>
  </form>

  <!--/*methods for testing queue*/-->
  <div class="queue-test-section" *ngIf="!isReply">
    <h4 (click)="toggleQueueTestSection()" class="queue-test-header">
      <span class="toggle-icon">{{ isQueueTestExpanded ? '‚àí' : '+' }}</span>
      Queue Testing
    </h4>

    <div *ngIf="isQueueTestExpanded" class="queue-test-content">
      <div class="test-buttons">
        <button type="button"
                class="btn-test-queue"
                (click)="testQueue()"
                [disabled]="isTestingQueue">
          {{ isTestingQueue ? 'Testing...' : 'Test Queue' }}
        </button>

        <button type="button"
                class="btn-queue-stats"
                (click)="showQueueStats()">
          Show Queue Stats
        </button>

        <button type="button"
                class="btn-clear-tests"
                (click)="clearQueueTests()">
          Clear Tests
        </button>
      </div>

      <div *ngIf="queueTestResult" class="queue-test-result">
        <h5>Queue Test Result:</h5>
        <pre>{{ queueTestResult | json }}</pre>

        <div *ngIf="currentQueueId" class="queue-status-monitor">
          <h6>Queue Status Monitor:</h6>
          <div class="status-item">
            <strong>Queue ID:</strong> {{ currentQueueId }}
          </div>
          <div class="status-item">
            <strong>Status:</strong>
            <span [class]="'status-' + (queueStatus?.status?.toLowerCase() || 'unknown')">
              {{ queueStatus?.status || 'Checking...' }}
            </span>
          </div>
          <div class="status-item" *ngIf="queueStatus?.processedAt">
            <strong>Processed At:</strong> {{ queueStatus.processedAt | date:'medium' }}
          </div>
          <div class="status-item" *ngIf="queueStatus?.errorMessage">
            <strong>Error:</strong>
            <span class="error-message">{{ queueStatus.errorMessage }}</span>
          </div>
        </div>
      </div>

      <div *ngIf="queueStats" class="queue-stats">
        <h5>Queue Statistics:</h5>
        <div class="stats-grid">
          <div class="stat-item">
            <span class="stat-label">Total Items:</span>
            <span class="stat-value">{{ queueStats.totalItems }}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Pending:</span>
            <span class="stat-value pending">{{ queueStats.pending }}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Processing:</span>
            <span class="stat-value processing">{{ queueStats.processing }}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Completed:</span>
            <span class="stat-value completed">{{ queueStats.completed }}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Failed:</span>
            <span class="stat-value failed">{{ queueStats.failed }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!--/*methods for testing queue*/-->
</div>
