<div class="comment-form-container">
  <h3>Add Comment</h3>

  <form class="comment-form" [formGroup]="commentForm" (ngSubmit)="onSubmit()">
    <div class="form-row">
      <div class="form-group">
        <label for="userName">User Name *</label>
        <input type="text"
               id="userName"
               class="form-control"
               formControlName="userName"
               autofocus
               placeholder="Your name">
        <div *ngIf="userName?.invalid && userName?.touched" class="error-message">
          <span *ngIf="userName?.errors?.['required']">Name is required</span>
          <span *ngIf="userName?.errors?.['minlength']">Name must be at least 2 characters</span>
        </div>
      </div>

      <div class="form-group">
        <label for="email">Email *</label>
        <input type="email"
               id="email"
               class="form-control"
               formControlName="email"
               placeholder="Your email">
        <div *ngIf="email?.invalid && email?.touched" class="error-message">
          <span *ngIf="email?.errors?.['required']">Email is required</span>
          <span *ngIf="email?.errors?.['email']">Please enter a valid email address</span>
        </div>
      </div>

      <div class="form-group">
        <label for="homepage">Homepage</label>
        <input type="url"
               id="homepage"
               class="form-control"
               formControlName="homepage"
               placeholder="Your website (optional)">
        <div *ngIf="homepage?.invalid && homepage?.touched" class="error-message">
          Please enter a valid URL
        </div>
      </div>
    </div>

    <div class="form-group">
      <div class="text-editor-header">
        <label for="text">Comment *</label>
        <button type="button"
                class="btn-html-toggle"
                (click)="toggleHtmlPanel()"
                [class.active]="showHtmlPanel">
          HTML
        </button>
      </div>

      <!-- HTML –ø–∞–Ω–µ–ª—å —Å –∫–Ω–æ–ø–∫–∞–º–∏ -->
      <div *ngIf="showHtmlPanel" class="html-panel">
        <div class="html-buttons">
          <button type="button"
                  class="html-btn"
                  (click)="insertHtmlTag('i')"
                  title="Italic">
            <i>I</i>
          </button>
          <button type="button"
                  class="html-btn"
                  (click)="insertHtmlTag('strong')"
                  title="Bold">
            <strong>B</strong>
          </button>
          <button type="button"
                  class="html-btn"
                  (click)="insertHtmlTag('code')"
                  title="Code">
            &lt;/&gt;
          </button>
          <button type="button"
                  class="html-btn"
                  (click)="insertLink()"
                  title="Insert Link">
            üîó
          </button>
        </div>
        <div class="html-hint">
          Select text and click buttons to wrap with HTML tags
        </div>
      </div>

      <textarea id="commentText"
                class="form-control"
                rows="5"
                formControlName="text"
                placeholder="Your comment"></textarea>
      <div *ngIf="text?.invalid && text?.touched" class="error-message">
        <span *ngIf="text?.errors?.['required']">Comment text is required</span>
        <span *ngIf="text?.errors?.['minlength']">Comment must be at least 5 characters</span>
      </div>
    </div>

    <!-- File Attachment Section -->
    <div class="form-group">
      <label>File Attachment</label>
      <div class="file-upload-section">
        <input type="file"
               #fileInput
               (change)="onFileSelected($event)"
               accept=".jpg,.jpeg,.png,.gif,.txt"
               class="file-input-hidden">

        <button type="button"
                class="file-upload-button"
                (click)="fileInput.click()">
          üìé Attach File
        </button>

        <small class="file-hint">
          Images: JPG, PNG, GIF (max 5MB, will be resized to 320√ó240px) | Text: TXT only (max 100KB)
        </small>

        <!-- Preview Section -->
        <div *ngIf="showPreview" class="preview-section">
          <app-comment-preview [commentData]="previewData"
                               [selectedFile]="selectedFile">
          </app-comment-preview>
        </div>
      </div>

      <!-- File validation errors -->
      <div *ngIf="fileError" class="error-message file-error">
        {{ fileError }}
      </div>
    </div>

    <!-- CAPTCHA Section -->
    <div class="form-group">
      <label>CAPTCHA *</label>
      <div class="captcha-section">
        <app-captcha (captchaChanged)="onCaptchaChanged($event)"></app-captcha>
        <input type="text"
               class="form-control"
               formControlName="captcha"
               placeholder="Enter symbols from image">
        <div *ngIf="captcha?.invalid && captcha?.touched" class="error-message">
          <span *ngIf="captcha?.errors?.['required']">CAPTCHA answer is required</span>
        </div>
        <div *ngIf="captchaServerError" class="error-message">
          {{ captchaServerError }}
        </div>
      </div>
    </div>

    <!-- Form Actions -->
    <div class="form-actions">
      <button type="button"
              class="btn-preview"
              (click)="togglePreview()"
              [disabled]="isSubmitting || commentForm.invalid">
        {{ showPreview ? 'Hide Preview' : 'Show Preview' }}
      </button>

      <button type="submit"
              class="btn-submit"
              [disabled]="!canSubmit()">
        <span class="btn-icon">
          {{ isSubmitting ? '‚è≥' : '‚úì' }}
        </span>
        {{ isSubmitting ? 'Submitting...' : 'Submit Comment' }}
      </button>
    </div>
  </form>

  <!-- Preview Section -->
  <div *ngIf="showPreview && commentForm.valid" class="preview-section">
    <h4>Comment Preview</h4>
    <div class="preview-content card">
      <div class="card-body">
        <div class="preview-header">
          <strong>{{ commentForm.get('userName')?.value || 'Anonymous' }}</strong>
          <span class="preview-email">{{ commentForm.get('email')?.value }}</span>
          <span *ngIf="commentForm.get('homepage')?.value" class="preview-homepage">
            ‚Ä¢ {{ commentForm.get('homepage')?.value }}
          </span>
        </div>
        <p class="preview-text" [innerHTML]="commentForm.get('text')?.value"></p>
        <div *ngIf="selectedFile" class="preview-file">
          <small>Attached file: {{ selectedFile.name }}</small>
          <span class="file-status pending">‚è≥ Will be uploaded with comment</span>
        </div>
      </div>
    </div>
  </div>
</div>
